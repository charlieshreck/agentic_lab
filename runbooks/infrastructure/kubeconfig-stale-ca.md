# Stale Kubeconfig CA After Cluster Rebuild

## Alert
- **Name**: KubeClientCertificateExpiration or kubectl TLS errors
- **Symptom**: `x509: certificate signed by unknown authority (ECDSA verification failure)` when using kubectl against a cluster
- **Severity**: Critical (blocks all kubectl access)

## Root Cause

When a Talos cluster is rebuilt/reprovisioned (via `terraform apply` or manual Talos reset), a new Kubernetes CA is generated. The unified kubeconfig at `/root/.kube/config` on Synapse LXC retains the old CA, causing TLS verification failures.

ArgoCD (on prod cluster) may be unaffected if it has its own cluster secret with updated credentials.

## Detection

```bash
# Test kubectl access to the affected cluster
KUBECONFIG=/root/.kube/config kubectl --context admin@monitoring-cluster get nodes

# If you see: x509: certificate signed by unknown authority
# Compare CA fingerprints:
KUBECONFIG=/root/.kube/config kubectl config view --raw \
  -o jsonpath='{.clusters[?(@.name=="monitoring-cluster")].cluster.certificate-authority-data}' \
  | base64 -d | openssl x509 -noout -fingerprint -dates

# vs the actual server CA:
echo | openssl s_client -connect 10.10.0.30:6443 2>&1 \
  | openssl x509 -noout -fingerprint -dates
```

## Resolution

### Step 1: Identify the correct kubeconfig source

Each cluster has a repo kubeconfig generated by Terraform:
- **Prod**: `/home/prod_homelab/infrastructure/terraform/generated/kubeconfig` (WARNING: may point to localhost:8080)
- **Agentic**: `/home/agentic_lab/infrastructure/terraform/talos-cluster/generated/kubeconfig`
- **Monit**: `/home/monit_homelab/kubeconfig` (or `terraform/talos-single-node/generated/kubeconfig`)

### Step 2: Verify the repo kubeconfig works

```bash
KUBECONFIG=/home/monit_homelab/kubeconfig kubectl get nodes
```

### Step 3: Update the unified kubeconfig

```bash
# Extract CA from repo kubeconfig
KUBECONFIG=/home/monit_homelab/kubeconfig kubectl config view --raw \
  -o jsonpath='{.clusters[0].cluster.certificate-authority-data}' \
  | base64 -d > /tmp/new-ca.pem

# Update unified kubeconfig CA
KUBECONFIG=/root/.kube/config kubectl config set-cluster monitoring-cluster \
  --server=https://10.10.0.30:6443 \
  --certificate-authority=/tmp/new-ca.pem \
  --embed-certs=true

# Extract and update client certs
KUBECONFIG=/home/monit_homelab/kubeconfig kubectl config view --raw \
  -o jsonpath='{.users[0].user.client-certificate-data}' \
  | base64 -d > /tmp/new-client-cert.pem
KUBECONFIG=/home/monit_homelab/kubeconfig kubectl config view --raw \
  -o jsonpath='{.users[0].user.client-key-data}' \
  | base64 -d > /tmp/new-client-key.pem

KUBECONFIG=/root/.kube/config kubectl config set-credentials admin@monitoring-cluster \
  --client-certificate=/tmp/new-client-cert.pem \
  --client-key=/tmp/new-client-key.pem \
  --embed-certs=true

# Clean up
rm -f /tmp/new-ca.pem /tmp/new-client-cert.pem /tmp/new-client-key.pem
```

### Step 4: Verify

```bash
KUBECONFIG=/root/.kube/config kubectl --context admin@monitoring-cluster get nodes
```

## Prevention

After any `terraform apply` that rebuilds a Talos cluster:
1. Update the unified kubeconfig immediately
2. Verify kubectl access from Synapse LXC
3. Verify ArgoCD can still manage the cluster

## History

| Date | Cluster | Cause | Resolution |
|------|---------|-------|------------|
| 2026-02-25 | monit | Cluster rebuilt Feb 19, unified kubeconfig not updated | Updated CA and client certs |
