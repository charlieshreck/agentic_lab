apiVersion: batch/v1
kind: Job
metadata:
  name: qdrant-init-collections
  namespace: ai-platform
  labels:
    app: qdrant
    component: init
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init
        image: curlimages/curl:8.5.0
        command:
        - /bin/sh
        - -c
        - |
          set -e
          QDRANT_URL="http://qdrant:6333"

          echo "Creating 'runbooks' collection..."
          curl -s -X PUT "${QDRANT_URL}/collections/runbooks" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating 'decisions' collection..."
          curl -s -X PUT "${QDRANT_URL}/collections/decisions" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating 'documentation' collection..."
          curl -s -X PUT "${QDRANT_URL}/collections/documentation" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating 'agent_events' collection..."
          curl -s -X PUT "${QDRANT_URL}/collections/agent_events" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating 'tool_knowledge' collection..."
          curl -s -X PUT "${QDRANT_URL}/collections/tool_knowledge" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating 'validations' collection..."
          curl -s -X PUT "${QDRANT_URL}/collections/validations" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating 'capability_gaps' collection..."
          curl -s -X PUT "${QDRANT_URL}/collections/capability_gaps" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating 'skill_gaps' collection..."
          curl -s -X PUT "${QDRANT_URL}/collections/skill_gaps" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating 'user_feedback' collection..."
          curl -s -X PUT "${QDRANT_URL}/collections/user_feedback" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating 'entities' collection (network entity inventory)..."
          curl -s -X PUT "${QDRANT_URL}/collections/entities" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating payload indexes for 'entities' collection..."
          # Index key fields for filtered queries
          curl -s -X PUT "${QDRANT_URL}/collections/entities/index" \
            -H "Content-Type: application/json" \
            -d '{"field_name": "ip", "field_schema": "keyword"}'
          curl -s -X PUT "${QDRANT_URL}/collections/entities/index" \
            -H "Content-Type: application/json" \
            -d '{"field_name": "mac", "field_schema": "keyword"}'
          curl -s -X PUT "${QDRANT_URL}/collections/entities/index" \
            -H "Content-Type: application/json" \
            -d '{"field_name": "hostname", "field_schema": "keyword"}'
          curl -s -X PUT "${QDRANT_URL}/collections/entities/index" \
            -H "Content-Type: application/json" \
            -d '{"field_name": "category", "field_schema": "keyword"}'
          curl -s -X PUT "${QDRANT_URL}/collections/entities/index" \
            -H "Content-Type: application/json" \
            -d '{"field_name": "type", "field_schema": "keyword"}'
          curl -s -X PUT "${QDRANT_URL}/collections/entities/index" \
            -H "Content-Type: application/json" \
            -d '{"field_name": "manufacturer", "field_schema": "keyword"}'
          curl -s -X PUT "${QDRANT_URL}/collections/entities/index" \
            -H "Content-Type: application/json" \
            -d '{"field_name": "network", "field_schema": "keyword"}'
          curl -s -X PUT "${QDRANT_URL}/collections/entities/index" \
            -H "Content-Type: application/json" \
            -d '{"field_name": "status", "field_schema": "keyword"}'

          echo ""
          echo "Creating 'device_types' collection (device control knowledge base)..."
          curl -s -X PUT "${QDRANT_URL}/collections/device_types" \
            -H "Content-Type: application/json" \
            -d '{
              "vectors": {
                "size": 768,
                "distance": "Cosine"
              },
              "on_disk_payload": true
            }'

          echo ""
          echo "Creating payload indexes for 'device_types' collection..."
          curl -s -X PUT "${QDRANT_URL}/collections/device_types/index" \
            -H "Content-Type: application/json" \
            -d '{"field_name": "name", "field_schema": "keyword"}'
          curl -s -X PUT "${QDRANT_URL}/collections/device_types/index" \
            -H "Content-Type: application/json" \
            -d '{"field_name": "category", "field_schema": "keyword"}'

          echo ""
          echo "Verifying collections..."
          curl -s "${QDRANT_URL}/collections" | grep -o '"name":"[^"]*"'
          echo ""
          echo "Done!"
