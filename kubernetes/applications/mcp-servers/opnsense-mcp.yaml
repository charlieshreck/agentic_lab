---
apiVersion: v1
kind: ConfigMap
metadata:
  name: opnsense-mcp-code
  namespace: ai-platform
data:
  main.py: |
    #!/usr/bin/env python3
    """OPNsense MCP server for firewall management."""
    import os, logging, httpx
    from typing import List, Dict, Any
    from fastmcp import FastMCP

    logging.basicConfig(level=logging.INFO)
    OPNSENSE_HOST = os.environ.get("OPNSENSE_HOST", "https://10.10.0.1")
    OPNSENSE_KEY = os.environ.get("OPNSENSE_KEY", "")
    OPNSENSE_SECRET = os.environ.get("OPNSENSE_SECRET", "")

    mcp = FastMCP(name="opnsense-mcp", instructions="MCP server for OPNsense firewall.")

    async def opnsense_api(endpoint: str) -> Dict[str, Any]:
        async with httpx.AsyncClient(verify=False, timeout=30.0) as client:
            response = await client.get(f"{OPNSENSE_HOST}/api{endpoint}", auth=(OPNSENSE_KEY, OPNSENSE_SECRET))
            response.raise_for_status()
            return response.json()

    @mcp.tool()
    async def get_interfaces() -> List[Dict[str, Any]]:
        """List network interfaces."""
        try: return await opnsense_api("/diagnostics/interface/getInterfaceStatistics")
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def get_firewall_rules() -> List[Dict[str, Any]]:
        """List firewall rules."""
        try: return await opnsense_api("/firewall/filter/searchRule")
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def get_dhcp_leases() -> List[Dict[str, Any]]:
        """List DHCP leases."""
        try: return await opnsense_api("/dhcpv4/leases/searchLease")
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def get_gateway_status() -> Dict[str, Any]:
        """Get gateway status."""
        try: return await opnsense_api("/routes/gateway/status")
        except Exception as e: return {"error": str(e)}

    if __name__ == "__main__":
        import uvicorn
        uvicorn.run(mcp.get_app(), host="0.0.0.0", port=8000)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opnsense-mcp
  namespace: ai-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: opnsense-mcp
  template:
    metadata:
      labels:
        app: opnsense-mcp
    spec:
      containers:
        - name: opnsense-mcp
          image: python:3.11-slim
          command: ["sh", "-c"]
          args:
            - pip install --no-cache-dir fastmcp httpx uvicorn && python /app/main.py
          ports:
            - containerPort: 8000
          env:
            - name: OPNSENSE_HOST
              value: "https://10.10.0.1"
            - name: OPNSENSE_KEY
              valueFrom:
                secretKeyRef:
                  name: mcp-opnsense
                  key: key
            - name: OPNSENSE_SECRET
              valueFrom:
                secretKeyRef:
                  name: mcp-opnsense
                  key: secret
          volumeMounts:
            - name: code
              mountPath: /app
          resources:
            requests: {memory: "128Mi", cpu: "100m"}
            limits: {memory: "256Mi", cpu: "500m"}
      volumes:
        - name: code
          configMap:
            name: opnsense-mcp-code
---
apiVersion: v1
kind: Service
metadata:
  name: opnsense-mcp
  namespace: ai-platform
spec:
  selector:
    app: opnsense-mcp
  ports:
    - port: 8000
      targetPort: 8000
