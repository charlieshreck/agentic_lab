apiVersion: v1
kind: ConfigMap
metadata:
  name: arr-suite-mcp-code
  namespace: ai-platform
  labels:
    app: arr-suite-mcp
data:
  main.py: |
    #!/usr/bin/env python3
    """Arr Suite MCP server for Sonarr, Radarr, Prowlarr management."""
    import os
    import logging
    import httpx
    from typing import List, Optional
    from fastmcp import FastMCP
    from pydantic import BaseModel

    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)

    SONARR_URL = os.environ.get("SONARR_URL", "http://sonarr:8989")
    SONARR_API_KEY = os.environ.get("SONARR_API_KEY", "")
    RADARR_URL = os.environ.get("RADARR_URL", "http://radarr:7878")
    RADARR_API_KEY = os.environ.get("RADARR_API_KEY", "")

    mcp = FastMCP(name="arr-suite-mcp", instructions="MCP server for media management.")

    class MediaItem(BaseModel):
        id: int
        title: str
        status: str
        monitored: bool

    async def arr_request(base_url: str, api_key: str, endpoint: str, method: str = "GET", data: dict = None) -> dict:
        async with httpx.AsyncClient(timeout=30.0) as client:
            response = await client.request(method, f"{base_url}/api/v3/{endpoint}", headers={"X-Api-Key": api_key}, json=data)
            response.raise_for_status()
            return response.json() if response.content else {}

    @mcp.tool()
    async def list_tv_shows(monitored_only: bool = True) -> List[MediaItem]:
        """List all TV shows in Sonarr."""
        try:
            shows = await arr_request(SONARR_URL, SONARR_API_KEY, "series")
            return [MediaItem(id=s["id"], title=s["title"], status=s["status"], monitored=s["monitored"]) for s in shows if not monitored_only or s["monitored"]]
        except Exception as e:
            logger.error(f"Failed: {e}")
            return []

    @mcp.tool()
    async def list_movies(monitored_only: bool = True) -> List[MediaItem]:
        """List all movies in Radarr."""
        try:
            movies = await arr_request(RADARR_URL, RADARR_API_KEY, "movie")
            return [MediaItem(id=m["id"], title=m["title"], status="downloaded" if m.get("hasFile") else "missing", monitored=m["monitored"]) for m in movies if not monitored_only or m["monitored"]]
        except Exception as e:
            logger.error(f"Failed: {e}")
            return []

    @mcp.tool()
    async def search_tv_show(query: str) -> List[dict]:
        """Search for a TV show to add to Sonarr."""
        try:
            results = await arr_request(SONARR_URL, SONARR_API_KEY, f"series/lookup?term={query}")
            return [{"tvdbId": r.get("tvdbId"), "title": r["title"], "year": r.get("year")} for r in results[:5]]
        except Exception as e:
            return [{"error": str(e)}]

    @mcp.tool()
    async def search_movie(query: str) -> List[dict]:
        """Search for a movie to add to Radarr."""
        try:
            results = await arr_request(RADARR_URL, RADARR_API_KEY, f"movie/lookup?term={query}")
            return [{"tmdbId": r.get("tmdbId"), "title": r["title"], "year": r.get("year")} for r in results[:5]]
        except Exception as e:
            return [{"error": str(e)}]

    @mcp.tool()
    async def get_download_queue() -> List[dict]:
        """Get current download queue from Sonarr and Radarr."""
        combined = []
        try:
            sonarr_queue = await arr_request(SONARR_URL, SONARR_API_KEY, "queue")
            for item in sonarr_queue.get("records", []):
                combined.append({"type": "tv", "title": item.get("title"), "status": item.get("status")})
        except:
            pass
        try:
            radarr_queue = await arr_request(RADARR_URL, RADARR_API_KEY, "queue")
            for item in radarr_queue.get("records", []):
                combined.append({"type": "movie", "title": item.get("title"), "status": item.get("status")})
        except:
            pass
        return combined

    @mcp.tool()
    async def get_system_status() -> dict:
        """Get system status from arr services."""
        status = {}
        for name, url, key in [("sonarr", SONARR_URL, SONARR_API_KEY), ("radarr", RADARR_URL, RADARR_API_KEY)]:
            try:
                info = await arr_request(url, key, "system/status")
                status[name] = {"version": info.get("version"), "status": "online"}
            except Exception as e:
                status[name] = {"status": "offline", "error": str(e)}
        return status

    def main():
        port = int(os.environ.get("PORT", "8000"))
        logger.info(f"Starting arr-suite MCP on port {port}")
        mcp.run(transport="sse", host="0.0.0.0", port=port)

    if __name__ == "__main__":
        main()

  requirements.txt: |
    fastmcp>=2.7.0
    pydantic>=2.11.0
    httpx>=0.28.0
    uvicorn>=0.34.0
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: arr-suite-mcp
  namespace: ai-platform
  labels:
    app: arr-suite-mcp
    component: mcp
spec:
  replicas: 1
  selector:
    matchLabels:
      app: arr-suite-mcp
  template:
    metadata:
      labels:
        app: arr-suite-mcp
        component: mcp
    spec:
      initContainers:
        - name: install-deps
          image: python:3.11-slim
          command: ['sh', '-c', 'pip install --target=/app/deps -r /code/requirements.txt']
          volumeMounts:
            - name: code
              mountPath: /code
            - name: deps
              mountPath: /app/deps
      containers:
        - name: mcp-server
          image: python:3.11-slim
          command: ['sh', '-c', 'cd /app && PYTHONPATH=/app/deps python /code/main.py']
          ports:
            - containerPort: 8000
              name: http
          env:
            - name: PORT
              value: "8000"
            - name: SONARR_URL
              valueFrom:
                secretKeyRef:
                  name: mcp-secrets
                  key: sonarr-url
                  optional: true
            - name: SONARR_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mcp-secrets
                  key: sonarr-api-key
                  optional: true
            - name: RADARR_URL
              valueFrom:
                secretKeyRef:
                  name: mcp-secrets
                  key: radarr-url
                  optional: true
            - name: RADARR_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mcp-secrets
                  key: radarr-api-key
                  optional: true
          volumeMounts:
            - name: code
              mountPath: /code
            - name: deps
              mountPath: /app/deps
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "500m"
          readinessProbe:
            httpGet:
              path: /sse
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
          livenessProbe:
            httpGet:
              path: /sse
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 5
      volumes:
        - name: code
          configMap:
            name: arr-suite-mcp-code
        - name: deps
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: arr-suite-mcp
  namespace: ai-platform
  labels:
    app: arr-suite-mcp
    component: mcp
spec:
  selector:
    app: arr-suite-mcp
  ports:
    - port: 8000
      targetPort: 8000
      name: http
