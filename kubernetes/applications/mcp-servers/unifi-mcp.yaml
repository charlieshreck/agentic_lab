---
apiVersion: v1
kind: ConfigMap
metadata:
  name: unifi-mcp-code
  namespace: ai-platform
data:
  main.py: |
    #!/usr/bin/env python3
    """UniFi MCP server for network management."""
    import os, logging, httpx
    from typing import List, Dict, Any
    from fastmcp import FastMCP

    logging.basicConfig(level=logging.INFO)
    UNIFI_HOST = os.environ.get("UNIFI_HOST", "https://10.10.0.1:443")
    UNIFI_API_KEY = os.environ.get("UNIFI_API_KEY", "")
    UNIFI_SITE = os.environ.get("UNIFI_SITE", "default")

    mcp = FastMCP(name="unifi-mcp", instructions="MCP server for UniFi network.")

    async def unifi_api(endpoint: str) -> Any:
        headers = {"X-API-KEY": UNIFI_API_KEY}
        async with httpx.AsyncClient(verify=False, timeout=30.0) as client:
            response = await client.get(f"{UNIFI_HOST}/proxy/network/api/s/{UNIFI_SITE}{endpoint}", headers=headers)
            response.raise_for_status()
            return response.json().get("data", [])

    @mcp.tool()
    async def list_clients() -> List[Dict[str, Any]]:
        """List connected clients."""
        try: return await unifi_api("/stat/sta")
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def list_devices() -> List[Dict[str, Any]]:
        """List UniFi devices."""
        try: return await unifi_api("/stat/device")
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def get_health() -> List[Dict[str, Any]]:
        """Get network health."""
        try: return await unifi_api("/stat/health")
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def get_alarms() -> List[Dict[str, Any]]:
        """Get active alarms."""
        try: return await unifi_api("/stat/alarm")
        except Exception as e: return [{"error": str(e)}]

    if __name__ == "__main__":
        import uvicorn
        uvicorn.run(mcp.get_app(), host="0.0.0.0", port=8000)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: unifi-mcp
  namespace: ai-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: unifi-mcp
  template:
    metadata:
      labels:
        app: unifi-mcp
    spec:
      containers:
        - name: unifi-mcp
          image: python:3.11-slim
          command: ["sh", "-c"]
          args:
            - pip install --no-cache-dir fastmcp httpx uvicorn && python /app/main.py
          ports:
            - containerPort: 8000
          env:
            - name: UNIFI_HOST
              value: "https://10.10.0.1:443"
            - name: UNIFI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mcp-unifi
                  key: UNIFI_API_KEY
          volumeMounts:
            - name: code
              mountPath: /app
          resources:
            requests: {memory: "128Mi", cpu: "100m"}
            limits: {memory: "256Mi", cpu: "500m"}
      volumes:
        - name: code
          configMap:
            name: unifi-mcp-code
---
apiVersion: v1
kind: Service
metadata:
  name: unifi-mcp
  namespace: ai-platform
spec:
  selector:
    app: unifi-mcp
  ports:
    - port: 8000
      targetPort: 8000
