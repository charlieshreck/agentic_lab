---
apiVersion: v1
kind: ConfigMap
metadata:
  name: truenas-mcp-code
  namespace: ai-platform
data:
  main.py: |
    #!/usr/bin/env python3
    """TrueNAS MCP server for storage management across multiple instances."""
    import os, logging, httpx
    from typing import List, Dict, Any
    from fastmcp import FastMCP

    logging.basicConfig(level=logging.INFO)
    logger = logging.getLogger(__name__)

    # Multi-instance configuration
    INSTANCES = {
        "hdd": {
            "host": os.environ.get("TRUENAS_HDD_HOST", "https://truenas.hdd.kernow.io"),
            "api_key": os.environ.get("TRUENAS_HDD_API_KEY", "")
        },
        "media": {
            "host": os.environ.get("TRUENAS_MEDIA_HOST", "https://truenas.kernow.io"),
            "api_key": os.environ.get("TRUENAS_MEDIA_API_KEY", "")
        }
    }

    mcp = FastMCP(name="truenas-mcp", instructions="MCP server for TrueNAS storage management. Supports two instances: 'hdd' (bulk storage) and 'media' (media files).")

    async def truenas_api(instance: str, endpoint: str, method: str = "GET", data: dict = None) -> Any:
        if instance not in INSTANCES:
            return {"error": f"Unknown instance: {instance}. Use 'hdd' or 'media'"}
        config = INSTANCES[instance]
        headers = {"Authorization": f"Bearer {config['api_key']}"}
        async with httpx.AsyncClient(verify=False, timeout=30.0) as client:
            url = f"{config['host']}/api/v2.0{endpoint}"
            if method == "GET":
                response = await client.get(url, headers=headers)
            else:
                response = await client.post(url, headers=headers, json=data)
            response.raise_for_status()
            return response.json()

    @mcp.tool()
    async def list_instances() -> List[Dict[str, str]]:
        """List available TrueNAS instances."""
        return [{"name": k, "host": v["host"]} for k, v in INSTANCES.items()]

    @mcp.tool()
    async def list_pools(instance: str = "hdd") -> List[Dict[str, Any]]:
        """List storage pools. Instance: 'hdd' or 'media'."""
        try: return await truenas_api(instance, "/pool")
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def list_datasets(instance: str = "hdd", pool: str = None) -> List[Dict[str, Any]]:
        """List datasets/filesystems. Instance: 'hdd' or 'media'."""
        try:
            datasets = await truenas_api(instance, "/pool/dataset")
            if pool:
                datasets = [d for d in datasets if d.get("pool") == pool]
            return datasets
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def get_system_info(instance: str = "hdd") -> Dict[str, Any]:
        """Get system information. Instance: 'hdd' or 'media'."""
        try: return await truenas_api(instance, "/system/info")
        except Exception as e: return {"error": str(e)}

    @mcp.tool()
    async def list_shares(instance: str = "hdd") -> Dict[str, Any]:
        """List all shares (SMB, NFS). Instance: 'hdd' or 'media'."""
        try:
            smb = await truenas_api(instance, "/sharing/smb")
            nfs = await truenas_api(instance, "/sharing/nfs")
            return {"instance": instance, "smb": smb, "nfs": nfs}
        except Exception as e: return {"error": str(e)}

    @mcp.tool()
    async def get_alerts(instance: str = "hdd") -> List[Dict[str, Any]]:
        """Get active alerts. Instance: 'hdd' or 'media'."""
        try: return await truenas_api(instance, "/alert/list")
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def get_all_alerts() -> Dict[str, List[Dict[str, Any]]]:
        """Get alerts from all TrueNAS instances."""
        results = {}
        for name in INSTANCES:
            try:
                results[name] = await truenas_api(name, "/alert/list")
            except Exception as e:
                results[name] = [{"error": str(e)}]
        return results

    @mcp.tool()
    async def list_snapshots(instance: str = "hdd", dataset: str = None) -> List[Dict[str, Any]]:
        """List ZFS snapshots. Instance: 'hdd' or 'media'."""
        try:
            snapshots = await truenas_api(instance, "/zfs/snapshot")
            if dataset:
                snapshots = [s for s in snapshots if s.get("dataset") == dataset]
            return snapshots
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def get_disk_usage(instance: str = "hdd") -> Dict[str, Any]:
        """Get disk usage summary. Instance: 'hdd' or 'media'."""
        try:
            pools = await truenas_api(instance, "/pool")
            return {
                "instance": instance,
                "pools": [{
                    "name": p.get("name"),
                    "size": p.get("size"),
                    "allocated": p.get("allocated"),
                    "free": p.get("free"),
                    "status": p.get("status")
                } for p in pools]
            }
        except Exception as e: return {"error": str(e)}

    if __name__ == "__main__":
        import uvicorn
        uvicorn.run(mcp.get_app(), host="0.0.0.0", port=8000)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: truenas-mcp
  namespace: ai-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: truenas-mcp
  template:
    metadata:
      labels:
        app: truenas-mcp
    spec:
      containers:
        - name: truenas-mcp
          image: python:3.11-slim
          command: ["sh", "-c"]
          args:
            - pip install --no-cache-dir fastmcp httpx uvicorn && python /app/main.py
          ports:
            - containerPort: 8000
          env:
            - name: TRUENAS_HDD_HOST
              valueFrom:
                secretKeyRef:
                  name: mcp-truenas-hdd
                  key: HOST
            - name: TRUENAS_HDD_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mcp-truenas-hdd
                  key: API_KEY
            - name: TRUENAS_MEDIA_HOST
              valueFrom:
                secretKeyRef:
                  name: mcp-truenas-media
                  key: HOST
            - name: TRUENAS_MEDIA_API_KEY
              valueFrom:
                secretKeyRef:
                  name: mcp-truenas-media
                  key: API_KEY
          volumeMounts:
            - name: code
              mountPath: /app
          resources:
            requests: {memory: "128Mi", cpu: "100m"}
            limits: {memory: "256Mi", cpu: "500m"}
      volumes:
        - name: code
          configMap:
            name: truenas-mcp-code
---
apiVersion: v1
kind: Service
metadata:
  name: truenas-mcp
  namespace: ai-platform
spec:
  selector:
    app: truenas-mcp
  ports:
    - port: 8000
      targetPort: 8000
