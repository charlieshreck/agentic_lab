---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudflare-mcp-code
  namespace: ai-platform
data:
  main.py: |
    #!/usr/bin/env python3
    """Cloudflare MCP server for DNS and tunnel management."""
    import os, logging, httpx
    from typing import List, Dict, Any
    from fastmcp import FastMCP

    logging.basicConfig(level=logging.INFO)
    CF_API_TOKEN = os.environ.get("CLOUDFLARE_API_TOKEN", "")
    CF_ACCOUNT_ID = os.environ.get("CLOUDFLARE_ACCOUNT_ID", "")

    mcp = FastMCP(name="cloudflare-mcp", instructions="MCP server for Cloudflare DNS and tunnels.")

    async def cf_api(endpoint: str, method: str = "GET", data: dict = None) -> Dict[str, Any]:
        headers = {"Authorization": f"Bearer {CF_API_TOKEN}"}
        async with httpx.AsyncClient(timeout=30.0) as client:
            if method == "GET":
                response = await client.get(f"https://api.cloudflare.com/client/v4{endpoint}", headers=headers)
            else:
                response = await client.post(f"https://api.cloudflare.com/client/v4{endpoint}", headers=headers, json=data)
            response.raise_for_status()
            return response.json()

    @mcp.tool()
    async def list_zones() -> List[Dict[str, Any]]:
        """List DNS zones."""
        try:
            result = await cf_api("/zones")
            return result.get("result", [])
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def list_dns_records(zone_id: str) -> List[Dict[str, Any]]:
        """List DNS records for a zone."""
        try:
            result = await cf_api(f"/zones/{zone_id}/dns_records")
            return result.get("result", [])
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def list_tunnels() -> List[Dict[str, Any]]:
        """List Cloudflare tunnels."""
        try:
            result = await cf_api(f"/accounts/{CF_ACCOUNT_ID}/cfd_tunnel")
            return result.get("result", [])
        except Exception as e: return [{"error": str(e)}]

    @mcp.tool()
    async def get_tunnel_status(tunnel_id: str) -> Dict[str, Any]:
        """Get tunnel status."""
        try:
            result = await cf_api(f"/accounts/{CF_ACCOUNT_ID}/cfd_tunnel/{tunnel_id}")
            return result.get("result", {})
        except Exception as e: return {"error": str(e)}

    if __name__ == "__main__":
        import uvicorn
        uvicorn.run(mcp.get_app(), host="0.0.0.0", port=8000)
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudflare-mcp
  namespace: ai-platform
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cloudflare-mcp
  template:
    metadata:
      labels:
        app: cloudflare-mcp
    spec:
      containers:
        - name: cloudflare-mcp
          image: python:3.11-slim
          command: ["sh", "-c"]
          args:
            - pip install --no-cache-dir fastmcp httpx uvicorn && python /app/main.py
          ports:
            - containerPort: 8000
          env:
            - name: CLOUDFLARE_API_TOKEN
              valueFrom:
                secretKeyRef:
                  name: mcp-cloudflare
                  key: CLOUDFLARE_API_TOKEN
            - name: CLOUDFLARE_ACCOUNT_ID
              valueFrom:
                secretKeyRef:
                  name: mcp-cloudflare
                  key: CLOUDFLARE_ACCOUNT_ID
          volumeMounts:
            - name: code
              mountPath: /app
          resources:
            requests: {memory: "128Mi", cpu: "100m"}
            limits: {memory: "256Mi", cpu: "500m"}
      volumes:
        - name: code
          configMap:
            name: cloudflare-mcp-code
---
apiVersion: v1
kind: Service
metadata:
  name: cloudflare-mcp
  namespace: ai-platform
spec:
  selector:
    app: cloudflare-mcp
  ports:
    - port: 8000
      targetPort: 8000
