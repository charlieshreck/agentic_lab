apiVersion: batch/v1
kind: CronJob
metadata:
  name: claude-token-monitor
  namespace: ai-platform
spec:
  schedule: "0 9 * * *"  # Daily at 9am
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: Never
          containers:
            - name: monitor
              image: curlimages/curl:8.5.0
              command:
                - /bin/sh
                - -c
                - |
                  set -e

                  # Check token status
                  echo "Checking Claude token status..."
                  STATUS=$(curl -sf http://claude-refresh.ai-platform.svc.cluster.local:8080/api/status)

                  DAYS=$(echo "$STATUS" | grep -o '"days_remaining":[0-9-]*' | cut -d: -f2)
                  EXPIRES=$(echo "$STATUS" | grep -o '"expires":"[^"]*"' | cut -d'"' -f4)
                  TOKEN_STATUS=$(echo "$STATUS" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)

                  echo "Days remaining: $DAYS"
                  echo "Expires: $EXPIRES"
                  echo "Status: $TOKEN_STATUS"

                  # Alert if under threshold
                  THRESHOLD=3
                  if [ "$DAYS" -lt "$THRESHOLD" ]; then
                    echo "Token expires in $DAYS days - sending alert!"

                    # Determine severity
                    if [ "$DAYS" -lt 0 ]; then
                      SEVERITY="critical"
                      MSG="Claude OAuth token has EXPIRED! Run 'claude login' immediately."
                    elif [ "$DAYS" -eq 0 ]; then
                      SEVERITY="critical"
                      MSG="Claude OAuth token expires TODAY! Run 'claude login' now."
                    else
                      SEVERITY="warning"
                      MSG="Claude OAuth token expires in $DAYS days. Run 'claude login' soon."
                    fi

                    # Send alert to Keep
                    curl -sf -X POST "${KEEP_URL}/alerts/event/keep" \
                      -H "Content-Type: application/json" \
                      -H "X-API-KEY: ${KEEP_API_KEY}" \
                      -d "{
                        \"name\": \"ClaudeOAuthTokenExpiry\",
                        \"status\": \"firing\",
                        \"severity\": \"$SEVERITY\",
                        \"description\": \"$MSG Expires: $EXPIRES\",
                        \"source\": \"claude-token-monitor\",
                        \"labels\": {
                          \"service\": \"claude-agent\",
                          \"namespace\": \"ai-platform\",
                          \"days_remaining\": \"$DAYS\"
                        }
                      }" || echo "Failed to send Keep alert"

                    # Exit with error to mark job as failed (visible in k8s)
                    exit 1
                  else
                    echo "Token healthy - $DAYS days remaining, no alert needed."
                  fi
              env:
                - name: KEEP_URL
                  value: "http://keep.keep.svc.cluster.local:8080"
                - name: KEEP_API_KEY
                  valueFrom:
                    secretKeyRef:
                      name: claude-refresh-secrets
                      key: KEEP_API_KEY
                      optional: true
