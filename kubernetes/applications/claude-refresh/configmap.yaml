apiVersion: v1
kind: ConfigMap
metadata:
  name: claude-refresh-code
  namespace: ai-platform
data:
  app.py: |
    #!/usr/bin/env python3
    """Claude OAuth Token Refresh Service - Mobile-first interactive wizard."""
    import os
    import json
    import base64
    import requests
    from datetime import datetime
    from flask import Flask, request, render_template_string

    app = Flask(__name__)

    # Infisical config
    INFISICAL_HOST = "https://app.infisical.com/api"
    INFISICAL_PROJECT_ID = os.environ.get("INFISICAL_PROJECT_ID")
    INFISICAL_CLIENT_ID = os.environ.get("INFISICAL_CLIENT_ID")
    INFISICAL_CLIENT_SECRET = os.environ.get("INFISICAL_CLIENT_SECRET")
    SECRET_PATH = "/agentic-platform/claude"
    SECRET_KEY = "CREDENTIALS_JSON_B64"

    # Keep config for alerts
    KEEP_URL = os.environ.get("KEEP_URL", "http://keep.keep.svc.cluster.local:8080")
    KEEP_API_KEY = os.environ.get("KEEP_API_KEY", "")

    HTML_TEMPLATE = """
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>Claude Token Refresh</title>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîë</text></svg>">
        <style>
            :root {
                --bg: #0d1117;
                --card: #161b22;
                --border: #30363d;
                --text: #e6edf3;
                --text-muted: #8b949e;
                --purple: #8b5cf6;
                --purple-glow: rgba(139, 92, 246, 0.3);
                --green: #22c55e;
                --green-glow: rgba(34, 197, 94, 0.3);
                --red: #ef4444;
                --orange: #f97316;
                --blue: #3b82f6;
            }
            * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin: 0; padding: 0;
                background: var(--bg);
                color: var(--text);
                min-height: 100vh;
                line-height: 1.5;
            }
            .container {
                max-width: 420px;
                margin: 0 auto;
                padding: 20px 16px 40px;
            }

            /* Header */
            .header {
                text-align: center;
                padding: 24px 0;
            }
            .header h1 {
                font-size: 28px;
                font-weight: 700;
                margin: 0 0 8px;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 12px;
            }
            .header p {
                color: var(--text-muted);
                margin: 0;
                font-size: 15px;
            }

            /* Status Card */
            .status-card {
                border-radius: 16px;
                padding: 20px;
                margin-bottom: 24px;
                display: flex;
                align-items: center;
                gap: 16px;
            }
            .status-card.expired {
                background: linear-gradient(135deg, rgba(239,68,68,0.15) 0%, rgba(239,68,68,0.05) 100%);
                border: 1px solid rgba(239,68,68,0.3);
            }
            .status-card.warning {
                background: linear-gradient(135deg, rgba(249,115,22,0.15) 0%, rgba(249,115,22,0.05) 100%);
                border: 1px solid rgba(249,115,22,0.3);
            }
            .status-card.valid {
                background: linear-gradient(135deg, rgba(34,197,94,0.15) 0%, rgba(34,197,94,0.05) 100%);
                border: 1px solid rgba(34,197,94,0.3);
            }
            .status-card.success {
                background: linear-gradient(135deg, rgba(34,197,94,0.15) 0%, rgba(34,197,94,0.05) 100%);
                border: 1px solid rgba(34,197,94,0.3);
            }
            .status-card.error {
                background: linear-gradient(135deg, rgba(239,68,68,0.15) 0%, rgba(239,68,68,0.05) 100%);
                border: 1px solid rgba(239,68,68,0.3);
            }
            .status-icon {
                font-size: 36px;
                line-height: 1;
            }
            .status-info h2 {
                font-size: 18px;
                font-weight: 600;
                margin: 0 0 4px;
            }
            .status-info p {
                font-size: 14px;
                color: var(--text-muted);
                margin: 0;
            }

            /* Steps */
            .steps {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .step {
                background: var(--card);
                border: 1px solid var(--border);
                border-radius: 16px;
                overflow: hidden;
                transition: all 0.3s ease;
            }
            .step.active {
                border-color: var(--purple);
                box-shadow: 0 0 20px var(--purple-glow);
            }
            .step.done {
                opacity: 0.5;
            }
            .step.done .step-badge {
                background: var(--green);
            }
            .step-header {
                padding: 18px 20px;
                display: flex;
                align-items: center;
                gap: 14px;
                cursor: pointer;
            }
            .step-badge {
                width: 36px; height: 36px;
                background: var(--purple);
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                font-size: 16px;
                flex-shrink: 0;
            }
            .step-title {
                flex: 1;
                font-weight: 600;
                font-size: 17px;
            }
            .step-check {
                color: var(--green);
                font-size: 20px;
            }
            .step-content {
                padding: 0 20px 20px;
                display: none;
            }
            .step.active .step-content {
                display: block;
            }
            .step-content p {
                color: var(--text-muted);
                margin: 0 0 16px;
                font-size: 15px;
            }

            /* Buttons */
            .btn {
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 10px;
                width: 100%;
                padding: 18px 24px;
                font-size: 17px;
                font-weight: 600;
                border: none;
                border-radius: 12px;
                cursor: pointer;
                text-decoration: none;
                transition: all 0.2s ease;
                -webkit-appearance: none;
            }
            .btn:active {
                transform: scale(0.98);
            }
            .btn-primary {
                background: var(--purple);
                color: white;
            }
            .btn-primary:hover {
                background: #9d6ffa;
            }
            .btn-success {
                background: var(--green);
                color: white;
            }
            .btn-outline {
                background: transparent;
                color: var(--text);
                border: 1px solid var(--border);
            }
            .btn-link {
                background: var(--blue);
                color: white;
            }
            .btn + .btn {
                margin-top: 10px;
            }
            .btn-icon {
                font-size: 20px;
            }

            /* Command box */
            .cmd-box {
                background: #0d1117;
                border: 1px solid var(--border);
                border-radius: 10px;
                padding: 14px 16px;
                margin: 16px 0;
                display: flex;
                align-items: center;
                gap: 12px;
            }
            .cmd-box code {
                flex: 1;
                font-family: 'SF Mono', Monaco, 'Courier New', monospace;
                font-size: 13px;
                color: #7ee787;
                white-space: nowrap;
                overflow-x: auto;
            }
            .cmd-copy {
                background: var(--purple);
                border: none;
                color: white;
                padding: 8px 14px;
                border-radius: 8px;
                font-size: 13px;
                font-weight: 600;
                cursor: pointer;
                flex-shrink: 0;
                transition: all 0.2s;
            }
            .cmd-copy.copied {
                background: var(--green);
            }

            /* Textarea */
            textarea {
                width: 100%;
                min-height: 120px;
                padding: 16px;
                font-size: 14px;
                font-family: 'SF Mono', Monaco, 'Courier New', monospace;
                border: 2px solid var(--border);
                border-radius: 12px;
                background: #0d1117;
                color: var(--text);
                resize: vertical;
                margin: 16px 0;
                -webkit-appearance: none;
            }
            textarea:focus {
                border-color: var(--purple);
                outline: none;
            }
            textarea::placeholder {
                color: var(--text-muted);
            }

            /* Hint */
            .hint {
                display: flex;
                align-items: flex-start;
                gap: 10px;
                padding: 14px;
                background: rgba(59, 130, 246, 0.1);
                border: 1px solid rgba(59, 130, 246, 0.2);
                border-radius: 10px;
                margin-top: 16px;
                font-size: 14px;
                color: var(--text-muted);
            }
            .hint-icon {
                font-size: 18px;
                flex-shrink: 0;
            }

            /* Loading */
            .loading {
                display: inline-block;
                width: 18px;
                height: 18px;
                border: 2px solid transparent;
                border-top-color: currentColor;
                border-radius: 50%;
                animation: spin 0.8s linear infinite;
            }
            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Quick paste mode */
            .quick-mode {
                margin-top: 32px;
                padding-top: 24px;
                border-top: 1px solid var(--border);
            }
            .quick-mode h3 {
                font-size: 15px;
                color: var(--text-muted);
                font-weight: 500;
                margin: 0 0 12px;
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üîë Token Refresh</h1>
                <p>Update Claude OAuth credentials</p>
            </div>

            {% if message %}
            <div class="status-card {{ status }}">
                <span class="status-icon">{% if status == 'success' %}‚úÖ{% elif status == 'error' %}‚ùå{% endif %}</span>
                <div class="status-info">
                    <h2>{{ message }}</h2>
                    {% if status == 'success' %}
                    <p>You're all set!</p>
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="status-card {% if days_remaining is none or days_remaining < 0 %}expired{% elif days_remaining < 7 %}warning{% else %}valid{% endif %}">
                <span class="status-icon">{% if days_remaining is none or days_remaining < 0 %}üî¥{% elif days_remaining < 7 %}üü°{% else %}üü¢{% endif %}</span>
                <div class="status-info">
                    {% if days_remaining is none or days_remaining < 0 %}
                    <h2>Token Expired</h2>
                    <p>Refresh now to restore access</p>
                    {% elif days_remaining < 7 %}
                    <h2>Expires in {{ days_remaining }} days</h2>
                    <p>Consider refreshing soon</p>
                    {% else %}
                    <h2>Valid for {{ days_remaining }} days</h2>
                    <p>Token is healthy</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="steps">
                <div class="step {% if step == 1 %}active{% elif step > 1 %}done{% endif %}" id="step1">
                    <div class="step-header" onclick="setStep(1)">
                        <span class="step-badge">1</span>
                        <span class="step-title">Login to Claude</span>
                        {% if step > 1 %}<span class="step-check">‚úì</span>{% endif %}
                    </div>
                    <div class="step-content">
                        <p>Open Claude and sign in with your account.</p>
                        <a href="https://claude.ai/login" target="_blank" class="btn btn-link">
                            <span class="btn-icon">üåê</span>
                            Open Claude Login
                        </a>
                        <button class="btn btn-primary" onclick="setStep(2)">
                            I'm logged in ‚Üí
                        </button>
                    </div>
                </div>

                <div class="step {% if step == 2 %}active{% elif step > 2 %}done{% endif %}" id="step2">
                    <div class="step-header" onclick="setStep(2)">
                        <span class="step-badge">2</span>
                        <span class="step-title">Copy Token</span>
                        {% if step > 2 %}<span class="step-check">‚úì</span>{% endif %}
                    </div>
                    <div class="step-content">
                        <p>On your computer terminal, run this command:</p>
                        <div class="cmd-box">
                            <code>cat ~/.claude/.credentials.json</code>
                            <button class="cmd-copy" onclick="copyCmd(this)">Copy</button>
                        </div>
                        <p>Copy the entire JSON output.</p>
                        <div class="hint">
                            <span class="hint-icon">üí°</span>
                            <span>You can paste either the raw JSON or base64 encoded - both work!</span>
                        </div>
                        <button class="btn btn-primary" onclick="setStep(3)">
                            I've copied it ‚Üí
                        </button>
                    </div>
                </div>

                <div class="step {% if step == 3 %}active{% endif %}" id="step3">
                    <div class="step-header" onclick="setStep(3)">
                        <span class="step-badge">3</span>
                        <span class="step-title">Paste & Save</span>
                    </div>
                    <div class="step-content">
                        <p>Paste the credentials below:</p>
                        <form method="POST" id="mainForm" onsubmit="return handleSubmit(event)">
                            <textarea name="credentials" id="credsInput"
                                placeholder='Paste JSON or base64 here...'
                                required>{{ credentials or '' }}</textarea>
                            <button type="submit" class="btn btn-success" id="submitBtn">
                                <span id="btnText">üöÄ Update Token</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="quick-mode">
                <h3>üñ•Ô∏è One-liner from your computer</h3>
                <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 12px;">
                    After running <code style="background: var(--card); padding: 2px 6px; border-radius: 4px;">claude login</code>, just run:
                </p>
                <div class="cmd-box" style="margin-bottom: 16px;">
                    <code style="font-size: 11px;">curl -X POST https://claude-refresh.kernow.io/api/push -H "Content-Type: application/json" -d @~/.claude/.credentials.json</code>
                    <button class="cmd-copy" onclick="copyCmd(this)" style="font-size: 11px; padding: 6px 10px;">Copy</button>
                </div>
                <p style="color: var(--text-muted); font-size: 13px;">
                    ‚ú® That's it! No phone needed.
                </p>
            </div>
        </div>

        <script>
            let currentStep = {{ step }};

            function setStep(n) {
                currentStep = n;
                document.querySelectorAll('.step').forEach((el, i) => {
                    el.classList.remove('active', 'done');
                    if (i + 1 < n) el.classList.add('done');
                    if (i + 1 === n) el.classList.add('active');
                });
                history.replaceState(null, '', '?step=' + n);
            }

            function copyCmd(btn) {
                const cmd = btn.previousElementSibling.textContent;
                navigator.clipboard.writeText(cmd).then(() => {
                    btn.textContent = '‚úì Copied';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = 'Copy';
                        btn.classList.remove('copied');
                    }, 2000);
                });
            }

            function handleSubmit(e) {
                const btn = e.target.querySelector('button[type="submit"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<span class="loading"></span> Updating...';
                btn.disabled = true;
                return true;
            }
        </script>
    </body>
    </html>
    """

    def get_infisical_token():
        """Get access token from Infisical using universal auth."""
        resp = requests.post(
            f"{INFISICAL_HOST}/v1/auth/universal-auth/login",
            json={
                "clientId": INFISICAL_CLIENT_ID,
                "clientSecret": INFISICAL_CLIENT_SECRET
            }
        )
        resp.raise_for_status()
        return resp.json()["accessToken"]

    def get_current_token_expiry():
        """Get current token expiration from Infisical."""
        try:
            token = get_infisical_token()
            resp = requests.get(
                f"{INFISICAL_HOST}/v3/secrets/raw/{SECRET_KEY}",
                params={
                    "workspaceSlug": "prod-homelab-y-nij",
                    "environment": "prod",
                    "secretPath": SECRET_PATH
                },
                headers={"Authorization": f"Bearer {token}"}
            )
            if resp.status_code == 200:
                secret_value = resp.json()["secret"]["secretValue"]
                creds = json.loads(base64.b64decode(secret_value))
                expires_at = creds.get("claudeAiOauth", {}).get("expiresAt", 0)
                expires_dt = datetime.fromtimestamp(expires_at / 1000)
                days_remaining = (expires_dt - datetime.now()).days
                return expires_at, days_remaining
        except Exception as e:
            app.logger.error(f"Error getting current token: {e}")
        return None, None

    def update_infisical_secret(value):
        """Update the secret in Infisical."""
        token = get_infisical_token()
        # v3 PATCH API expects all params in JSON body
        resp = requests.patch(
            f"{INFISICAL_HOST}/v3/secrets/raw/{SECRET_KEY}",
            headers={
                "Authorization": f"Bearer {token}",
                "Content-Type": "application/json"
            },
            json={
                "workspaceSlug": "prod-homelab-y-nij",
                "environment": "prod",
                "secretPath": SECRET_PATH,
                "secretValue": value
            }
        )
        if resp.status_code in [200, 201]:
            return True
        app.logger.error(f"Failed to update secret: {resp.status_code} {resp.text}")
        return False

    def send_resolved_alert(days_remaining, expires_date):
        """Send resolved alert to Keep."""
        if not KEEP_API_KEY:
            return
        try:
            requests.post(
                f"{KEEP_URL}/alerts/event/keep",
                headers={
                    "Content-Type": "application/json",
                    "X-API-KEY": KEEP_API_KEY
                },
                json={
                    "name": "ClaudeOAuthTokenExpiry",
                    "status": "resolved",
                    "severity": "info",
                    "description": f"Claude OAuth token refreshed. Valid for {days_remaining} days until {expires_date}.",
                    "source": "claude-refresh",
                    "labels": {
                        "service": "claude-agent",
                        "namespace": "ai-platform",
                        "days_remaining": str(days_remaining)
                    }
                },
                timeout=5
            )
        except Exception as e:
            app.logger.error(f"Failed to send resolved alert: {e}")

    @app.route("/", methods=["GET", "POST"])
    def index():
        expires_at, days_remaining = get_current_token_expiry()
        message = None
        status = None
        credentials = None
        step = int(request.args.get("step", 1))

        if request.method == "POST":
            step = 3
            raw_input = request.form.get("credentials", "").strip()

            if not raw_input:
                message = "Please paste credentials"
                status = "error"
            else:
                try:
                    # Try to detect if input is JSON or base64
                    creds = None
                    encoded_value = None

                    # First, try to parse as raw JSON
                    if raw_input.startswith('{'):
                        try:
                            creds = json.loads(raw_input)
                            # If successful, base64 encode for storage
                            encoded_value = base64.b64encode(raw_input.encode()).decode()
                        except json.JSONDecodeError:
                            pass

                    # If not JSON, try base64 decode
                    if creds is None:
                        try:
                            decoded = base64.b64decode(raw_input)
                            creds = json.loads(decoded)
                            encoded_value = raw_input  # Already base64
                        except Exception:
                            raise ValueError("Could not parse as JSON or base64. Please check your input.")

                    # Validate the credential structure
                    oauth = creds.get("claudeAiOauth", {})
                    if not oauth.get("accessToken") or not oauth.get("expiresAt"):
                        raise ValueError("Missing accessToken or expiresAt in credentials")

                    new_expires = oauth["expiresAt"]
                    new_expires_dt = datetime.fromtimestamp(new_expires / 1000)
                    new_days = (new_expires_dt - datetime.now()).days

                    if new_days < 0:
                        message = "These credentials are already expired!"
                        status = "error"
                    else:
                        if update_infisical_secret(encoded_value):
                            message = f"Token updated! Valid for {new_days} days"
                            status = "success"
                            expires_at = new_expires
                            days_remaining = new_days
                            credentials = None
                            step = 1
                            send_resolved_alert(new_days, new_expires_dt.strftime("%Y-%m-%d"))
                        else:
                            message = "Failed to update Infisical"
                            status = "error"

                except json.JSONDecodeError:
                    message = "Invalid JSON format"
                    status = "error"
                except ValueError as e:
                    message = str(e)
                    status = "error"
                except Exception as e:
                    message = f"Error: {str(e)}"
                    status = "error"

        return render_template_string(
            HTML_TEMPLATE,
            message=message,
            status=status,
            expires_at=expires_at,
            days_remaining=days_remaining or 0,
            credentials=credentials,
            step=step
        )

    @app.route("/health")
    def health():
        return {"status": "ok"}

    @app.route("/api/push", methods=["POST"])
    def api_push():
        """API endpoint for direct push from computer terminal.
        Usage: curl -X POST https://claude-refresh.kernow.io/api/push -H "Content-Type: application/json" -d @~/.claude/.credentials.json
        """
        try:
            # Accept raw JSON body
            creds = request.get_json(force=True)

            if not creds:
                return {"error": "No JSON body provided"}, 400

            # Validate structure
            oauth = creds.get("claudeAiOauth", {})
            if not oauth.get("accessToken") or not oauth.get("expiresAt"):
                return {"error": "Invalid credentials format - missing accessToken or expiresAt"}, 400

            # Check expiry
            new_expires = oauth["expiresAt"]
            new_expires_dt = datetime.fromtimestamp(new_expires / 1000)
            new_days = (new_expires_dt - datetime.now()).days

            if new_days < 0:
                return {"error": "Token is already expired", "expires": new_expires_dt.isoformat()}, 400

            # Encode and store
            encoded = base64.b64encode(json.dumps(creds).encode()).decode()
            if update_infisical_secret(encoded):
                send_resolved_alert(new_days, new_expires_dt.strftime("%Y-%m-%d"))
                return {
                    "success": True,
                    "message": f"Token updated! Valid for {new_days} days",
                    "expires": new_expires_dt.isoformat(),
                    "days_remaining": new_days
                }
            else:
                return {"error": "Failed to update Infisical"}, 500

        except json.JSONDecodeError:
            return {"error": "Invalid JSON"}, 400
        except Exception as e:
            return {"error": str(e)}, 500

    if __name__ == "__main__":
        app.run(host="0.0.0.0", port=8080)
