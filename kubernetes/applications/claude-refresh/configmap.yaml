apiVersion: v1
kind: ConfigMap
metadata:
  name: claude-refresh-code
  namespace: ai-platform
data:
  app.py: |
    #!/usr/bin/env python3
    """Claude OAuth Token Refresh Service - Interactive wizard."""
    import os
    import json
    import base64
    import requests
    from datetime import datetime
    from flask import Flask, request, render_template_string

    app = Flask(__name__)

    # Infisical config
    INFISICAL_HOST = "https://app.infisical.com/api"
    INFISICAL_PROJECT_ID = os.environ.get("INFISICAL_PROJECT_ID")
    INFISICAL_CLIENT_ID = os.environ.get("INFISICAL_CLIENT_ID")
    INFISICAL_CLIENT_SECRET = os.environ.get("INFISICAL_CLIENT_SECRET")
    SECRET_PATH = "/agentic-platform/claude"
    SECRET_KEY = "CREDENTIALS_JSON_B64"

    # Keep config for alerts
    KEEP_URL = os.environ.get("KEEP_URL", "http://keep.keep.svc.cluster.local:8080")
    KEEP_API_KEY = os.environ.get("KEEP_API_KEY", "")

    HTML_TEMPLATE = """
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
        <title>Claude Token Refresh</title>
        <style>
            * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                margin: 0; padding: 16px;
                background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                color: #eee;
                min-height: 100vh;
            }
            .container { max-width: 500px; margin: 0 auto; }
            h1 {
                color: #fff; font-size: 1.4em; margin: 0 0 16px 0;
                display: flex; align-items: center; gap: 10px;
            }
            .status-banner {
                padding: 12px 16px; border-radius: 12px; margin-bottom: 20px;
                display: flex; align-items: center; gap: 12px;
            }
            .status-banner.expired { background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); }
            .status-banner.warning { background: linear-gradient(135deg, #d35400 0%, #e67e22 100%); }
            .status-banner.valid { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
            .status-banner.success { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
            .status-banner.error { background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%); }
            .status-icon { font-size: 1.5em; }
            .status-text { flex: 1; }
            .status-text strong { display: block; font-size: 1.1em; }
            .status-text small { opacity: 0.9; }

            .step {
                background: rgba(255,255,255,0.05);
                border-radius: 16px;
                margin-bottom: 12px;
                overflow: hidden;
                border: 1px solid rgba(255,255,255,0.1);
            }
            .step.active { border-color: #667eea; }
            .step.done { opacity: 0.6; }
            .step-header {
                padding: 16px;
                display: flex; align-items: center; gap: 12px;
                cursor: pointer;
            }
            .step-num {
                width: 32px; height: 32px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border-radius: 50%;
                display: flex; align-items: center; justify-content: center;
                font-weight: bold; font-size: 1em;
                flex-shrink: 0;
            }
            .step.done .step-num { background: #27ae60; }
            .step-title { flex: 1; font-weight: 600; }
            .step-content {
                padding: 0 16px 16px 60px;
                display: none;
            }
            .step.active .step-content { display: block; }

            .btn {
                display: block; width: 100%;
                padding: 16px 20px;
                font-size: 16px; font-weight: 600;
                border: none; border-radius: 12px;
                cursor: pointer;
                text-decoration: none;
                text-align: center;
                margin-top: 12px;
                transition: transform 0.1s, opacity 0.1s;
            }
            .btn:active { transform: scale(0.98); opacity: 0.9; }
            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }
            .btn-secondary {
                background: rgba(255,255,255,0.1);
                color: #fff;
                border: 1px solid rgba(255,255,255,0.2);
            }
            .btn-success {
                background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
                color: white;
            }

            .code-box {
                background: #0a0a15;
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 8px;
                padding: 12px;
                font-family: 'SF Mono', Monaco, monospace;
                font-size: 13px;
                overflow-x: auto;
                white-space: nowrap;
                margin: 12px 0;
                position: relative;
            }
            .code-box code { color: #a8e6cf; }
            .copy-btn {
                position: absolute;
                right: 8px; top: 8px;
                background: #667eea;
                border: none;
                color: white;
                padding: 6px 12px;
                border-radius: 6px;
                font-size: 12px;
                cursor: pointer;
            }
            .copy-btn.copied { background: #27ae60; }

            textarea {
                width: 100%;
                height: 100px;
                padding: 12px;
                font-size: 14px;
                font-family: 'SF Mono', Monaco, monospace;
                border: 2px solid rgba(255,255,255,0.1);
                border-radius: 12px;
                background: #0a0a15;
                color: #fff;
                resize: none;
                margin: 12px 0;
            }
            textarea:focus {
                border-color: #667eea;
                outline: none;
            }

            .helper-text {
                font-size: 0.85em;
                color: rgba(255,255,255,0.6);
                margin-top: 8px;
            }

            .checkmark { color: #2ecc71; margin-left: 8px; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üîë Claude Token</h1>

            {% if message %}
            <div class="status-banner {{ status }}">
                <span class="status-icon">{% if status == 'success' %}‚úÖ{% else %}‚ùå{% endif %}</span>
                <div class="status-text">
                    <strong>{{ message }}</strong>
                </div>
            </div>
            {% else %}
            <div class="status-banner {% if days_remaining < 0 %}expired{% elif days_remaining < 7 %}warning{% else %}valid{% endif %}">
                <span class="status-icon">{% if days_remaining < 0 %}üî¥{% elif days_remaining < 7 %}üü°{% else %}üü¢{% endif %}</span>
                <div class="status-text">
                    {% if days_remaining < 0 %}
                    <strong>Expired {{ -days_remaining }} days ago</strong>
                    <small>Token needs refresh</small>
                    {% elif days_remaining < 7 %}
                    <strong>Expires in {{ days_remaining }} days</strong>
                    <small>Refresh soon</small>
                    {% else %}
                    <strong>Valid for {{ days_remaining }} days</strong>
                    <small>All good!</small>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <div class="step {% if step == 1 %}active{% elif step > 1 %}done{% endif %}" id="step1">
                <div class="step-header" onclick="setStep(1)">
                    <span class="step-num">1</span>
                    <span class="step-title">Login to Claude</span>
                    {% if step > 1 %}<span class="checkmark">‚úì</span>{% endif %}
                </div>
                <div class="step-content">
                    <p>On your computer, open terminal and run:</p>
                    <div class="code-box">
                        <code>claude login</code>
                        <button class="copy-btn" onclick="copyText('claude login', this)">Copy</button>
                    </div>
                    <p class="helper-text">This opens a browser to authenticate with Anthropic.</p>
                    <button class="btn btn-primary" onclick="setStep(2)">Done, Next ‚Üí</button>
                </div>
            </div>

            <div class="step {% if step == 2 %}active{% elif step > 2 %}done{% endif %}" id="step2">
                <div class="step-header" onclick="setStep(2)">
                    <span class="step-num">2</span>
                    <span class="step-title">Copy credentials</span>
                    {% if step > 2 %}<span class="checkmark">‚úì</span>{% endif %}
                </div>
                <div class="step-content">
                    <p>Run this to get the token:</p>
                    <div class="code-box">
                        <code>cat ~/.claude/.credentials.json | base64 -w0</code>
                        <button class="copy-btn" onclick="copyText('cat ~/.claude/.credentials.json | base64 -w0', this)">Copy</button>
                    </div>
                    <p class="helper-text">Copy the entire output (it's one long line).</p>
                    <button class="btn btn-primary" onclick="setStep(3)">Copied, Next ‚Üí</button>
                </div>
            </div>

            <div class="step {% if step == 3 %}active{% endif %}" id="step3">
                <div class="step-header" onclick="setStep(3)">
                    <span class="step-num">3</span>
                    <span class="step-title">Paste & Update</span>
                </div>
                <div class="step-content">
                    <form method="POST" id="updateForm">
                        <input type="hidden" name="step" value="3">
                        <textarea name="credentials"
                                  placeholder="Paste the base64 output here..."
                                  required>{{ credentials or '' }}</textarea>
                        <button type="submit" class="btn btn-success">üöÄ Update Token</button>
                    </form>
                </div>
            </div>
        </div>

        <script>
            let currentStep = {{ step }};

            function setStep(n) {
                currentStep = n;
                document.querySelectorAll('.step').forEach((el, i) => {
                    el.classList.remove('active', 'done');
                    if (i + 1 < n) el.classList.add('done');
                    if (i + 1 === n) el.classList.add('active');
                });
                // Update URL without reload
                history.replaceState(null, '', '?step=' + n);
            }

            function copyText(text, btn) {
                navigator.clipboard.writeText(text).then(() => {
                    btn.textContent = 'Copied!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = 'Copy';
                        btn.classList.remove('copied');
                    }, 2000);
                });
            }
        </script>
    </body>
    </html>
    """

    def get_infisical_token():
        """Get access token from Infisical using universal auth."""
        resp = requests.post(
            f"{INFISICAL_HOST}/v1/auth/universal-auth/login",
            json={
                "clientId": INFISICAL_CLIENT_ID,
                "clientSecret": INFISICAL_CLIENT_SECRET
            }
        )
        resp.raise_for_status()
        return resp.json()["accessToken"]

    def get_current_token_expiry():
        """Get current token expiration from Infisical."""
        try:
            token = get_infisical_token()
            resp = requests.get(
                f"{INFISICAL_HOST}/v3/secrets/raw/{SECRET_KEY}",
                params={
                    "workspaceSlug": "prod-homelab-y-nij",
                    "environment": "prod",
                    "secretPath": SECRET_PATH
                },
                headers={"Authorization": f"Bearer {token}"}
            )
            if resp.status_code == 200:
                secret_value = resp.json()["secret"]["secretValue"]
                creds = json.loads(base64.b64decode(secret_value))
                expires_at = creds.get("claudeAiOauth", {}).get("expiresAt", 0)
                expires_dt = datetime.fromtimestamp(expires_at / 1000)
                days_remaining = (expires_dt - datetime.now()).days
                return expires_at, days_remaining
        except Exception as e:
            app.logger.error(f"Error getting current token: {e}")
        return None, None

    def update_infisical_secret(value):
        """Update the secret in Infisical."""
        token = get_infisical_token()
        resp = requests.patch(
            f"{INFISICAL_HOST}/v3/secrets/raw/{SECRET_KEY}",
            params={
                "workspaceSlug": "prod-homelab-y-nij",
                "environment": "prod",
                "secretPath": SECRET_PATH
            },
            headers={"Authorization": f"Bearer {token}"},
            json={"secretValue": value}
        )
        if resp.status_code in [200, 201]:
            return True
        app.logger.error(f"Failed to update secret: {resp.status_code} {resp.text}")
        return False

    def send_resolved_alert(days_remaining, expires_date):
        """Send resolved alert to Keep."""
        if not KEEP_API_KEY:
            return
        try:
            requests.post(
                f"{KEEP_URL}/alerts/event/keep",
                headers={
                    "Content-Type": "application/json",
                    "X-API-KEY": KEEP_API_KEY
                },
                json={
                    "name": "ClaudeOAuthTokenExpiry",
                    "status": "resolved",
                    "severity": "info",
                    "description": f"Claude OAuth token refreshed. Valid for {days_remaining} days until {expires_date}.",
                    "source": "claude-refresh",
                    "labels": {
                        "service": "claude-agent",
                        "namespace": "ai-platform",
                        "days_remaining": str(days_remaining)
                    }
                },
                timeout=5
            )
        except Exception as e:
            app.logger.error(f"Failed to send resolved alert: {e}")

    @app.route("/", methods=["GET", "POST"])
    def index():
        expires_at, days_remaining = get_current_token_expiry()
        message = None
        status = None
        credentials = None
        step = int(request.args.get("step", 1))

        if request.method == "POST":
            step = 3
            credentials = request.form.get("credentials", "").strip()

            if not credentials:
                message = "Please paste credentials"
                status = "error"
            else:
                try:
                    decoded = base64.b64decode(credentials)
                    creds = json.loads(decoded)
                    oauth = creds.get("claudeAiOauth", {})
                    if not oauth.get("accessToken") or not oauth.get("expiresAt"):
                        raise ValueError("Missing accessToken or expiresAt")

                    new_expires = oauth["expiresAt"]
                    new_expires_dt = datetime.fromtimestamp(new_expires / 1000)
                    new_days = (new_expires_dt - datetime.now()).days

                    if new_days < 0:
                        message = "These credentials are already expired!"
                        status = "error"
                    else:
                        if update_infisical_secret(credentials):
                            message = f"Token updated! Valid for {new_days} days"
                            status = "success"
                            expires_at = new_expires
                            days_remaining = new_days
                            credentials = None
                            step = 1
                            send_resolved_alert(new_days, new_expires_dt.strftime("%Y-%m-%d"))
                        else:
                            message = "Failed to update Infisical"
                            status = "error"

                except json.JSONDecodeError:
                    message = "Invalid JSON - check you copied the full output"
                    status = "error"
                except Exception as e:
                    message = f"Error: {str(e)}"
                    status = "error"

        return render_template_string(
            HTML_TEMPLATE,
            message=message,
            status=status,
            expires_at=expires_at,
            days_remaining=days_remaining or 0,
            credentials=credentials,
            step=step
        )

    @app.route("/health")
    def health():
        return {"status": "ok"}

    if __name__ == "__main__":
        app.run(host="0.0.0.0", port=8080)
