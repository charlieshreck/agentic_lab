---
# DISABLED: Cloud LLM replaced with local Ollama inference
# Validation now handled by Ollama (qwen2.5:7b) or Brain Trust humans
# Claude Code (CLI) is still used for implementation after Brain Trust approval
# To re-enable: set replicas back to 3 and restore OAuth credentials
apiVersion: apps/v1
kind: Deployment
metadata:
  name: claude-agent
  namespace: ai-platform
  labels:
    app: claude-agent
    component: agent
spec:
  replicas: 0  # DISABLED - using Ollama for all inference
  selector:
    matchLabels:
      app: claude-agent
  template:
    metadata:
      labels:
        app: claude-agent
        component: agent
    spec:
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      initContainers:
        - name: setup
          image: node:22-bookworm
          securityContext:
            runAsUser: 0  # Root for package installation
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -e
              echo "=== Installing Python ==="
              apt-get update && apt-get install -y python3 python3-pip python3-venv --no-install-recommends

              echo "=== Setting up user home ==="
              mkdir -p /home/agent/.claude /home/agent/.kube /home/agent/.local /home/agent/.npm-global
              chown -R 1000:1000 /home/agent

              echo "=== Setting up /root for Claude CLI workaround ==="
              # Claude Code CLI has hardcoded /root/.claude.json path regardless of HOME
              # Make /root writable by agent user as workaround
              mkdir -p /root/.claude
              chown -R 1000:1000 /root

              echo "=== Installing Claude Code to shared location ==="
              # Install to shared volume location accessible by non-root user
              mkdir -p /opt/node-bin
              cd /opt/node-bin
              npm init -y
              npm install @anthropic-ai/claude-code
              # Create wrapper script
              echo '#!/bin/bash' > /opt/node-bin/claude
              echo 'exec /opt/node-bin/node_modules/.bin/claude "$@"' >> /opt/node-bin/claude
              chmod 755 /opt/node-bin/claude
              chown -R 1000:1000 /opt/node-bin

              echo "=== Creating venv ==="
              python3 -m venv /opt/venv
              chown -R 1000:1000 /opt/venv
              . /opt/venv/bin/activate
              pip install --no-cache-dir -r /app/requirements.txt

              echo "✓ Setup complete"
          volumeMounts:
            - name: code
              mountPath: /app
            - name: agent-home
              mountPath: /home/agent
            - name: venv
              mountPath: /opt/venv
            - name: node-bin
              mountPath: /opt/node-bin
            - name: root-home
              mountPath: /root
      containers:
        - name: claude-agent
          image: node:22-bookworm
          command: ["/bin/bash", "-c"]
          args:
            - |
              set -e
              export HOME=/home/agent

              echo "=== Setting up Claude credentials ==="
              mkdir -p $HOME/.claude
              if [ -f /secrets/claude/CREDENTIALS_JSON_B64 ]; then
                  base64 -d /secrets/claude/CREDENTIALS_JSON_B64 > $HOME/.claude/.credentials.json
                  chmod 600 $HOME/.claude/.credentials.json
                  echo "✓ Claude credentials configured"
              fi

              echo "=== Setting up kubeconfigs ==="
              mkdir -p $HOME/.kube
              if [ -f /secrets/claude/KUBECONFIG_MERGED_B64 ]; then
                  base64 -d /secrets/claude/KUBECONFIG_MERGED_B64 > $HOME/.kube/config
                  chmod 600 $HOME/.kube/config
                  echo "✓ Kubeconfig configured (prod, monit, agentic)"
              fi

              echo "=== Setting up workspace with context ==="
              mkdir -p /workspace
              # Copy CLAUDE.md context to workspace so agent can read it
              if [ -f /context/CLAUDE.md ]; then
                  cp /context/CLAUDE.md /workspace/CLAUDE.md
                  echo "✓ CLAUDE.md context loaded"
              fi

              echo "=== Starting API Server ==="
              cd /app
              . /opt/venv/bin/activate
              exec uvicorn main:app --host 0.0.0.0 --port 8000
          ports:
            - containerPort: 8000
              name: http
          env:
            - name: HOME
              value: "/home/agent"
            - name: PATH
              value: "/opt/node-bin:/opt/venv/bin:/usr/local/bin:/usr/bin:/bin"
            - name: REDIS_URL
              value: "redis://redis:6379"
            # Do NOT set ANTHROPIC_API_KEY - use subscription auth
          # Import ALL MCP server URLs from shared ConfigMap
          envFrom:
            - configMapRef:
                name: mcp-servers-config
          volumeMounts:
            - name: code
              mountPath: /app
            - name: claude-credentials
              mountPath: /secrets/claude
              readOnly: true
            - name: workspace
              mountPath: /workspace
            - name: agent-home
              mountPath: /home/agent
            - name: venv
              mountPath: /opt/venv
            - name: node-bin
              mountPath: /opt/node-bin
            - name: root-home
              mountPath: /root
            - name: claude-context
              mountPath: /context
              readOnly: true
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "2000m"
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 120
            periodSeconds: 60
            timeoutSeconds: 10
            failureThreshold: 6  # Allow 6 minutes of failures before restart
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 90
            periodSeconds: 10
            timeoutSeconds: 5
      volumes:
        - name: code
          configMap:
            name: claude-agent-code
            defaultMode: 0755
        - name: claude-credentials
          secret:
            secretName: claude-credentials
        - name: claude-context
          configMap:
            name: claude-agent-context
        - name: workspace
          emptyDir: {}
        - name: agent-home
          emptyDir: {}
        - name: venv
          emptyDir: {}
        - name: node-bin
          emptyDir: {}
        - name: root-home
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: claude-agent
  namespace: ai-platform
  labels:
    app: claude-agent
spec:
  selector:
    app: claude-agent
  ports:
    - port: 8000
      targetPort: 8000
      nodePort: 30200
      name: http
  type: NodePort
