---
# SSH keys for Backrest to access backup targets
apiVersion: secrets.infisical.com/v1alpha1
kind: InfisicalSecret
metadata:
  name: backrest-ssh-keys-raw
  namespace: backrest
spec:
  hostAPI: https://app.infisical.com/api
  authentication:
    universalAuth:
      credentialsRef:
        secretName: universal-auth-credentials
        secretNamespace: infisical-operator-system
      secretsScope:
        projectSlug: prod-homelab-y-nij
        envSlug: prod
        secretsPath: /backups/backrest
  managedSecretReference:
    secretName: backrest-ssh-keys-raw
    secretNamespace: backrest
    secretType: Opaque
    creationPolicy: Owner
---
# Job to transform SSH keys into proper format
apiVersion: batch/v1
kind: Job
metadata:
  name: backrest-ssh-transformer
  namespace: backrest
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  template:
    spec:
      serviceAccountName: backrest-ssh-transformer
      restartPolicy: OnFailure
      containers:
      - name: transformer
        image: bitnami/kubectl:latest
        command:
        - /bin/sh
        - -c
        - |
          set -e

          # Wait for the raw secret
          timeout=60
          while [ $timeout -gt 0 ]; do
            if kubectl get secret backrest-ssh-keys-raw -n backrest >/dev/null 2>&1; then
              echo "Raw secret found"
              break
            fi
            echo "Waiting for raw secret..."
            sleep 2
            timeout=$((timeout-2))
          done

          if [ $timeout -le 0 ]; then
            echo "Timeout waiting for raw secret"
            exit 1
          fi

          # Extract keys
          PRIVATE_KEY=$(kubectl get secret backrest-ssh-keys-raw -n backrest -o jsonpath='{.data.SSH_PRIVATE_KEY}' | base64 -d)
          PUBLIC_KEY=$(kubectl get secret backrest-ssh-keys-raw -n backrest -o jsonpath='{.data.SSH_PUBLIC_KEY}' | base64 -d)

          # Create the SSH keys secret with proper file names
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Secret
          metadata:
            name: backrest-ssh-keys
            namespace: backrest
          type: Opaque
          stringData:
            id_ed25519: |
          $(echo "$PRIVATE_KEY" | sed 's/^/      /')
            id_ed25519.pub: |
          $(echo "$PUBLIC_KEY" | sed 's/^/      /')
            config: |
              Host iac
                HostName 10.10.0.100
                User root
                StrictHostKeyChecking no

              Host plex
                HostName 10.10.0.50
                User root
                StrictHostKeyChecking no

              Host unifi
                HostName 10.10.0.51
                User root
                StrictHostKeyChecking no

              Host truenas-hdd
                HostName 10.20.0.103
                User root
                StrictHostKeyChecking no

              Host truenas-media
                HostName 10.20.0.100
                User root
                StrictHostKeyChecking no
          EOF

          echo "Backrest SSH keys secret created successfully"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backrest-ssh-transformer
  namespace: backrest
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: backrest-ssh-transformer
  namespace: backrest
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
rules:
- apiGroups: [""]
  resources: ["secrets"]
  verbs: ["get", "create", "update", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: backrest-ssh-transformer
  namespace: backrest
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: backrest-ssh-transformer
subjects:
- kind: ServiceAccount
  name: backrest-ssh-transformer
  namespace: backrest
