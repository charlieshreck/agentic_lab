apiVersion: batch/v1
kind: CronJob
metadata:
  name: graph-sync
  namespace: ai-platform
  labels:
    app: graph-sync
    component: discovery
spec:
  schedule: "15 */4 * * *"  # Every 4 hours, 15 min after discovery
  concurrencyPolicy: Forbid  # Prevent overlapping runs
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      activeDeadlineSeconds: 600  # 10 minute timeout (multi-cluster)
      template:
        metadata:
          labels:
            app: graph-sync
        spec:
          restartPolicy: Never
          hostAliases:
          - ip: "10.30.0.90"
            hostnames:
            - gatus.monit.kernow.io
          containers:
          - name: graph-sync
            image: ghcr.io/charlieshreck/agentic_lab/discovery-service:latest
            env:
            - name: NEO4J_URI
              value: "bolt://neo4j:7687"
            - name: NEO4J_USER
              value: "neo4j"
            - name: NEO4J_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: neo4j-credentials
                  key: NEO4J_PASSWORD
            # Consolidated MCP endpoints (cluster-internal)
            - name: INFRASTRUCTURE_MCP_URL
              value: "http://infrastructure-mcp:8000"
            - name: KNOWLEDGE_MCP_URL
              value: "http://knowledge-mcp:8000"
            - name: OBSERVABILITY_MCP_URL
              value: "http://observability-mcp:8000"
            - name: HOME_MCP_URL
              value: "http://home-mcp:8000"
            - name: GATUS_URL
              value: "http://gatus.monit.kernow.io"
            - name: MEDIA_MCP_URL
              value: "http://media-mcp:8000"
            resources:
              requests:
                memory: "128Mi"
                cpu: "100m"
              limits:
                memory: "256Mi"
                cpu: "500m"
